<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ניהול ספרים - ספרייה</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            min-height: 100vh;
        }
        .container { padding-top: 2rem; }
        .card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
            background: rgba(255,255,255,0.95);
        }
        .card-header {
            background: linear-gradient(45deg, #11998e, #38ef7d);
            border-radius: 15px 15px 0 0 !important;
            color: white;
            padding: 1.5rem;
        }
        .btn-custom {
            background: linear-gradient(45deg, #11998e, #38ef7d);
            border: none;
            border-radius: 25px;
            padding: 0.5rem 1.5rem;
            color: white;
            transition: all 0.3s ease;
        }
        .btn-custom:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            color: white;
        }
        .book-card {
            transition: transform 0.2s;
            margin-bottom: 1rem;
            height: 100%;
        }
        .book-card:hover {
            transform: translateY(-3px);
        }
        .book-cover {
            background: linear-gradient(45deg, #667eea, #764ba2);
            height: 200px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 3rem;
            border-radius: 10px 10px 0 0;
        }
        .status-available {
            background-color: #28a745;
            color: white;
        }
        .status-borrowed {
            background-color: #dc3545;
            color: white;
        }
        .filter-tabs {
            background: rgba(255,255,255,0.9);
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 2rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-lg-12">
                <div class="card">
                    <div class="card-header text-center">
                        <h2><i class="fas fa-books me-3"></i>ניהול ספרים</h2>
                        <div class="mt-3">
                            <a href="/books/add" class="btn btn-custom me-2">
                                <i class="fas fa-plus me-2"></i>הוסף ספר חדש
                            </a>
                            <button class="btn btn-custom" onclick="toggleFilters()">
                                <i class="fas fa-filter me-2"></i>מסננים
                            </button>
                        </div>
                    </div>
                    <div class="card-body p-4">
                        <!-- מסננים וחיפוש -->
                        <div class="filter-tabs" id="filterSection" style="display: none;">
                            <div class="row">
                                <div class="col-md-4">
                                    <input type="text" id="searchInput" class="form-control" placeholder="חפש לפי כותרת או מחבר...">
                                </div>
                                <div class="col-md-3">
                                    <select id="categoryFilter" class="form-select">
                                        <option value="">כל הקטגוריות</option>
                                        <option value="fiction">ספרות</option>
                                        <option value="science">מדע</option>
                                        <option value="history">היסטוריה</option>
                                        <option value="biography">ביוגרפיה</option>
                                        <option value="children">ילדים</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <select id="statusFilter" class="form-select">
                                        <option value="">כל הסטטוסים</option>
                                        <option value="available">זמין</option>
                                        <option value="borrowed">שאול</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <button onclick="clearFilters()" class="btn btn-outline-secondary w-100">
                                        <i class="fas fa-times"></i> נקה
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- סטטיסטיקות מהירות -->
                        <div class="row mb-4">
                            <div class="col-md-3">
                                <div class="card bg-primary text-white">
                                    <div class="card-body text-center">
                                        <h3><%= books ? books.length : 0 %></h3>
                                        <small>סה"כ ספרים</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card bg-success text-white">
                                    <div class="card-body text-center">
                                        <h3><%= books ? books.filter(book => book.isAvailable !== false).length : 0 %></h3>
                                        <small>ספרים זמינים</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card bg-danger text-white">
                                    <div class="card-body text-center">
                                        <h3><%= books ? books.filter(book => book.isAvailable === false).length : 0 %></h3>
                                        <small>ספרים שאולים</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card bg-info text-white">
                                    <div class="card-body text-center">
                                        <h3><%= books ? [...new Set(books.map(book => book.author))].length : 0 %></h3>
                                        <small>מחברים</small>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- רשימת ספרים -->
                        <div class="row" id="booksList">
                            <% if (typeof books !== 'undefined' && books.length > 0) { %>
                                <% books.forEach(book => { %>
                                    <div class="col-md-6 col-lg-4 col-xl-3 mb-4 book-item" 
                                         data-title="<%= (book.title || '').toLowerCase() %>"
                                         data-author="<%= (book.author || '').toLowerCase() %>"
                                         data-category="<%= book.category || '' %>"
                                         data-status="<%= book.isAvailable === false ? 'borrowed' : 'available' %>">
                                        <div class="card book-card">
                                            <div class="book-cover">
                                                <i class="fas fa-book"></i>
                                            </div>
                                            <div class="card-body">
                                                <h6 class="card-title text-truncate" title="<%= book.title || 'ללא כותרת' %>">
                                                    <%= book.title || 'ללא כותרת' %>
                                                </h6>
                                                <p class="card-text">
                                                    <small class="text-muted">
                                                        <i class="fas fa-user me-1"></i>
                                                        <%= book.author || 'לא צוין' %>
                                                    </small><br>
                                                    <small class="text-muted">
                                                        <i class="fas fa-barcode me-1"></i>
                                                        <%= book.isbn || 'לא צוין' %>
                                                    </small>
                                                </p>
                                                <div class="mb-2">
                                                    <span class="badge <%= book.isAvailable === false ? 'status-borrowed' : 'status-available' %>">
                                                        <i class="fas <%= book.isAvailable === false ? 'fa-user-clock' : 'fa-check' %> me-1"></i>
                                                        <%= book.isAvailable === false ? 'שאול' : 'זמין' %>
                                                    
                                                    <% if (book.category) { %>
                                                        <span class="badge bg-secondary ms-1">
                                                            <%= book.category %>
                                                        
                                                    <% } %>
                                                </div>
                                            </div>
                                            <div class="card-footer">
                                                <div class="btn-group w-100">
                                                    <a href="/books/<%= book._id %>" class="btn btn-info btn-sm">
                                                        <i class="fas fa-eye"></i>
                                                    </a>
                                                    <a href="/books/update/<%= book._id %>" class="btn btn-warning btn-sm">
                                                        <i class="fas fa-edit"></i>
                                                    </a>
                                                    <% if (book.isAvailable !== false) { %>
                                                        <button onclick="borrowBook('<%= book._id %>')" class="btn btn-success btn-sm">
                                                            <i class="fas fa-hand-holding"></i>
                                                        </button>
                                                    <% } else { %>
                                                        <button onclick="returnBook('<%= book._id %>')" class="btn btn-primary btn-sm">
                                                            <i class="fas fa-undo"></i>
                                                        </button>
                                                    <% } %>
                                                    <button onclick="deleteBook('<%= book._id %>')" class="btn btn-danger btn-sm">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                <% }) %>
                            <% } else { %>
                                <div class="col-12">
                                    <div class="text-center py-5">
                                        <i class="fas fa-books fa-5x text-muted mb-4"></i>
                                        <h4>אין ספרים במערכת</h4>
                                        <p class="text-muted">התחל בהוספת הספר הראשון שלך</p>
                                        <a href="/books/add" class="btn btn-custom">
                                            <i class="fas fa-plus me-2"></i>הוסף ספר ראשון
                                        </a>
                                    </div>
                                </div>
                            <% } %>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // הצגה/הסתרה של מסננים
        function toggleFilters() {
            const filterSection = document.getElementById('filterSection');
            filterSection.style.display = filterSection.style.display === 'none' ? 'block' : 'none';
        }

        // חיפוש וסינון
        function filterBooks() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const categoryFilter = document.getElementById('categoryFilter').value;
            const statusFilter = document.getElementById('statusFilter').value;
            const bookItems = document.querySelectorAll('.book-item');
            
            bookItems.forEach(item => {
                const title = item.dataset.title;
                const author = item.dataset.author;
                const category = item.dataset.category;
                const status = item.dataset.status;
                
                const matchesSearch = title.includes(searchTerm) || author.includes(searchTerm);
                const matchesCategory = !categoryFilter || category === categoryFilter;
                const matchesStatus = !statusFilter || status === statusFilter;
                
                if (matchesSearch && matchesCategory && matchesStatus) {
                    item.style.display = 'block';
                } else {
                    item.style.display = 'none';
                }
            });
        }

        // אירועי חיפוש וסינון
        document.getElementById('searchInput').addEventListener('input', filterBooks);
        document.getElementById('categoryFilter').addEventListener('change', filterBooks);
        document.getElementById('statusFilter').addEventListener('change', filterBooks);

        // ניקוי מסננים
        function clearFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('categoryFilter').value = '';
            document.getElementById('statusFilter').value = '';
            filterBooks();
        }

        // השאלת ספר
        function borrowBook(bookId) {
            const borrowerId = prompt('הכנס מזהה שואל:');
            if (borrowerId) {
                fetch(`/books/borrow/${bookId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ borrowerId: borrowerId })
                }).then(response => {
                    if (response.ok) {
                        location.reload();
                    } else {
                        alert('שגיאה בהשאלת הספר');
                    }
                });
            }
        }

        // החזרת ספר
        function returnBook(bookId) {
            if (confirm('האם אתה בטוח שברצונך להחזיר את הספר?')) {
                fetch(`/books/return/${bookId}`, {
                    method: 'POST'
                }).then(response => {
                    if (response.ok) {
                        location.reload();
                    } else {
                        alert('שגיאה בהחזרת הספר');
                    }
                });
            }
        }

        // מחיקת ספר
        function deleteBook(bookId) {
            if (confirm('האם אתה בטוח שברצונך למחוק את הספר? פעולה זו לא ניתנת לביטול.')) {
                fetch(`/books/delete/${bookId}`, {
                    method: 'DELETE'
                }).then(response => {
                    if (response.ok) {
                        location.reload();
                    } else {
                        alert('שגיאה במחיקת הספר');
                    }
                });
            }
        }
    </script>
</body>
</html>
